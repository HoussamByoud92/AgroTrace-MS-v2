services:
  # ==========================================
  # Shared Infrastructure
  # ==========================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - agro-net

  kafka:
    image: confluentinc/cp-kafka:7.3.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "${KAFKA_PORT}:9092"
    environment:
      KAFKA_BROKER_ID: ${KAFKA_BROKER_ID}
      KAFKA_ZOOKEEPER_CONNECT: ${KAFKA_ZOOKEEPER_CONNECT}
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:${KAFKA_PORT}
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - agro-net
    restart: unless-stopped

  timescaledb:
    image: timescale/timescaledb:latest-pg14
    container_name: timescaledb
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${TIMESCALE_DB}
    ports:
      - "5432:5432"
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
      - ./infra/postgres-init:/docker-entrypoint-initdb.d
    networks:
      - agro-net
    restart: unless-stopped

  postgis:
    image: postgis/postgis:14-3.3
    container_name: postgis
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGIS_DB}
    ports:
      - "5433:5432"
    volumes:
      - postgis_data:/var/lib/postgresql/data
    networks:
      - agro-net
    restart: unless-stopped

  minio:
    image: minio/minio
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - agro-net
    restart: unless-stopped

  minio-init:
    image: minio/mc
    container_name: minio-init
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c " until mc alias set myminio http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}; do echo '...waiting for minio...' && sleep 1; done; mc mb --ignore-existing myminio/images; mc mb --ignore-existing myminio/models; mc mb --ignore-existing myminio/logs; mc anonymous set public myminio/images; exit 0; "
    networks:
      - agro-net

  # ==========================================
  # Microservices
  # ==========================================
  auth-service:
    build: ./services/auth-service
    container_name: auth-service
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${AUTH_DB}
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "8001:8000"
    depends_on:
      - timescaledb
    networks:
      - agro-net

  ingestion-capteurs:
    build: ./services/ingestion-capteurs
    container_name: ingestion-capteurs
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      TIMESCALE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${TIMESCALE_DB}
    ports:
      - "8002:8000"
    volumes:
      - ./sample_training_data.csv:/app/data/sample_training_data.csv
    depends_on:
      - kafka
      - timescaledb
    networks:
      - agro-net

  pre-traitement:
    build: ./services/pre-traitement
    container_name: pre-traitement
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
    depends_on:
      - kafka
      - minio
    networks:
      - agro-net

  vision-plante:
    build: ./services/vision-plante
    container_name: vision-plante
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgis:5432/${POSTGIS_DB}
    volumes:
      - ./services/vision-plante:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      - minio
      - kafka
      - postgis
    ports:
      - "8004:8000"
    networks:
      - agro-net

  prevision-eau:
    build: ./services/prevision-eau
    container_name: prevision-eau
    environment:
      TIMESCALE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${TIMESCALE_DB}
    ports:
      - "8003:8000"
    depends_on:
      - timescaledb
    networks:
      - agro-net

  regles-agro:
    build: ./services/regles-agro
    container_name: regles-agro
    environment:
      POSTGRES_URL: jdbc:postgresql://postgis:5432/${POSTGIS_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    depends_on:
      - postgis
    networks:
      - agro-net

  reco-irrigation:
    build: ./services/reco-irrigation
    container_name: reco-irrigation
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgis:5432/${POSTGIS_DB}
    depends_on:
      - postgis
      - regles-agro
      - prevision-eau
    ports:
      - "8006:8000"
    networks:
      - agro-net

  db-explorer:
    build: ./services/db-explorer
    container_name: db-explorer
    environment:
      TIMESCALE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${TIMESCALE_DB}
      AUTH_DB_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${AUTH_DB}
      POSTGIS_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgis:5432/${POSTGIS_DB}
    volumes:
      - ./services/db-explorer:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8005:8000"
    depends_on:
      - timescaledb
      - postgis
    networks:
      - agro-net
    restart: unless-stopped

  frontend:
    build: ./frontend
    container_name: frontend
    ports:
      - "3000:80"
    networks:
      - agro-net
    restart: unless-stopped

  gateway:
    image: nginx:alpine
    container_name: gateway
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
    depends_on:
      - auth-service
      - ingestion-capteurs
      - frontend
    networks:
      - agro-net

volumes:
  timescaledb_data:
  postgis_data:
  minio_data:


networks:
  agro-net:
    driver: bridge
